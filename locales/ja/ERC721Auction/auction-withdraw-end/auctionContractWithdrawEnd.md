このセクションでは、コントラクトを完成させます。引き出し用の関数を作成し、入札を引き出せるようにします。また、オークションを終了するための関数を作成します。

### 引き出し

ローカル変数である`bal`(balance)を作成し、前回の引き出し以降に関数の呼び出し元が入札した入札の総額を格納します(75行目)。 関数の呼び出し元のアドレスをキーとして、bidsマッピングにアクセスすることで、値を`bal`に割り当てます。

次に、bidsマッピングでは、関数の呼び出しているアドレスの値に対して0を設定します。関数を呼び出しているアドレスが入札の総額を引き出すためです(76行目)。

それから、ETHをコントラクトから関数の呼び出し元へ送信します。また、`Withdraw`イベントを発行します(79行目)。

### 終了

関数の呼び出し元が、end関数を実行し、オークションを終了する前に、特定の条件を満たしているかを確認します。 このオークションが、開始されており(83行目)、オークションの終了日に達しており(84行目)、オークションが終了されていないこと(85行目)必要があります。

オークションが終了すると、状態変数`ended`に`true`を設定します(87行目)。

このオークションに誰かが参加しており、NFTに集札しているかどうかを確認します(88行目)。

入札があれば、NFTをコントラクトから最高入札者に送信します(89行目)。そして、ETHを最高入札者から、このコントラクトに送信します。これは、NFTの売り手である競売人のアドレスです(90行目)。

誰もこのNFTに入札していない場合は、NFTを売り手に送り返します(92行目)。

最後に、`End`イベントを発行します(95行目)。

## ⭐️ 演習

1. NFTコントラクトをデプロイします。 LearnEthの「Solidity NFTコース」で作成したNFTコントラクトを使用します。

2. tokenId 0のNFTをミントしてください。

3. テストのために、`endAt`状態変数の割当を`7 days`から`5 minutes`に変更してください。

4. EnglishAuctionコントラクトをデプロイします。 NFTコントラクトのアドレスを引数である`_nft`パラメータにして、`_nftId`に0、`_startingBid`を1にしてください。

5. NFTコントラクトの `approve` 関数のパラメータで、オークションコントラクトのアドレスを`to`、`tokenId`を0にして呼び出してください。

6. オークションコントラクトの`start`関数を呼び出します。

7. アカウント1で2 Etherを入札します。そして、アカウント2で3 Etherを入札します。 これで、`highestBidder`関数を呼び出すと、アカウント2のアドレスが返されます。

8. `withdraw`関数をアカウント1で呼び出してください。 アカウント1の残高が、トランザクション手数料とともに2 Ether引かれていることが確認できます。

9. 5分経過後に`end`関数を呼び出します。 その後、`ended`関数を呼び出すと`true`が返されます。

NFTコントラクトでは、tokenId 0で`ownerOf`関数を呼び出すと、アカウント2のアドレスが返されます。 アカウント1の残高を見ると、トランザクション手数料が引かれた3 Ether分が増えています。
